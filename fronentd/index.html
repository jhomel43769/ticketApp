<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TicketApp API Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">TicketApp API Tester</h1>
        
        <!-- Auth Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">🔐 Autenticación</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Register -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="text-lg font-medium mb-3 text-gray-600">Registrar Usuario</h3>
                    <form id="registerForm" class="space-y-3">
                        <input type="text" id="regUsername" placeholder="Username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <input type="email" id="regEmail" placeholder="Email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <input type="password" id="regPassword" placeholder="Password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <input type="text" id="regFirstName" placeholder="Nombre" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <input type="text" id="regLastName" placeholder="Apellido" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <input type="text" id="regRole" placeholder="Role ID" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button type="submit" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">Registrar</button>
                    </form>
                </div>
                
                <!-- Login -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="text-lg font-medium mb-3 text-gray-600">Iniciar Sesión</h3>
                    <form id="loginForm" class="space-y-3">
                        <input type="email" id="loginEmail" placeholder="Email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <input type="password" id="loginPassword" placeholder="Password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button type="submit" class="w-full bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition-colors">Iniciar Sesión</button>
                    </form>
                    <div id="authStatus" class="mt-3 text-sm font-medium"></div>
                </div>
            </div>
        </div>

        <!-- Projects Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">📁 Proyectos</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Create Project -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="text-lg font-medium mb-3 text-gray-600">Crear Proyecto</h3>
                    <form id="createProjectForm" class="space-y-3">
                        <input type="text" id="projectName" placeholder="Nombre del proyecto" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <textarea id="projectDescription" placeholder="Descripción" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3"></textarea>
                        <input type="text" id="projectLeader" placeholder="ID del líder (opcional)" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button type="submit" class="w-full bg-purple-500 text-white py-2 px-4 rounded-md hover:bg-purple-600 transition-colors">Crear Proyecto</button>
                    </form>
                </div>
                
                <!-- List Projects -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="text-lg font-medium mb-3 text-gray-600">Proyectos</h3>
                    <button id="loadProjects" class="w-full bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600 transition-colors mb-3">Cargar Proyectos</button>
                    <div id="projectsList" class="space-y-2 max-h-40 overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <!-- Issues Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">🎫 Issues</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Create Issue -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="text-lg font-medium mb-3 text-gray-600">Crear Issue</h3>
                    <form id="createIssueForm" class="space-y-3">
                        <input type="text" id="issueTitle" placeholder="Título" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <textarea id="issueDescription" placeholder="Descripción" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3"></textarea>
                        <select id="issueType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Seleccionar tipo</option>
                            <option value="Peticion">Petición</option>
                            <option value="Tarea">Tarea</option>
                            <option value="Error">Error</option>
                        </select>
                        <select id="issuePriority" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Seleccionar prioridad</option>
                            <option value="Baja">Baja</option>
                            <option value="Media">Media</option>
                            <option value="Alta">Alta</option>
                            <option value="Critica">Crítica</option>
                        </select>
                        <input type="text" id="issueProject" placeholder="ID del proyecto" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <input type="text" id="issueAssignedTo" placeholder="ID del usuario asignado (opcional)" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <input type="date" id="issueDueDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button type="submit" class="w-full bg-orange-500 text-white py-2 px-4 rounded-md hover:bg-orange-600 transition-colors">Crear Issue</button>
                    </form>
                </div>
                
                <!-- List Issues -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="text-lg font-medium mb-3 text-gray-600">Issues</h3>
                    <button id="loadIssues" class="w-full bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition-colors mb-3">Cargar Issues</button>
                    <div id="issuesList" class="space-y-2 max-h-40 overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">👥 Usuarios</h2>
            <div class="flex gap-4 mb-4">
                <button id="loadUsers" class="bg-cyan-500 text-white py-2 px-4 rounded-md hover:bg-cyan-600 transition-colors">Cargar Usuarios</button>
            </div>
            <div id="usersList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <!-- Response Display -->
        <div class="bg-gray-800 rounded-lg p-6 text-white">
            <h2 class="text-xl font-semibold mb-4">📊 Respuesta del Servidor</h2>
            <pre id="responseDisplay" class="bg-gray-900 p-4 rounded-lg text-sm overflow-x-auto whitespace-pre-wrap">Aquí se mostrarán las respuestas del servidor...</pre>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        let authToken = null;
        let currentUser = null;

        // Utility functions
        function displayResponse(data) {
            document.getElementById('responseDisplay').textContent = JSON.stringify(data, null, 2);
        }

        function showError(message) {
            displayResponse({ error: message });
        }

        function updateAuthStatus() {
            const statusDiv = document.getElementById('authStatus');
            if (authToken) {
                statusDiv.innerHTML = `<span class="text-green-600">✓ Autenticado: ${currentUser?.username || 'Usuario'}</span>`;
            } else {
                statusDiv.innerHTML = `<span class="text-red-600">✗ No autenticado</span>`;
            }
        }

        async function makeRequest(endpoint, method = 'GET', data = null, isFormData = false) {
            try {
                const config = {
                    method,
                    headers: {}
                };

                if (authToken) {
                    config.headers['Authorization'] = `Bearer ${authToken}`;
                }

                if (data) {
                    if (isFormData) {
                        config.body = data;
                    } else {
                        config.headers['Content-Type'] = 'application/json';
                        config.body = JSON.stringify(data);
                    }
                }

                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                const result = await response.json();
                
                displayResponse(result);
                return result;
            } catch (error) {
                showError(error.message);
                return null;
            }
        }

        // Auth functions
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                username: document.getElementById('regUsername').value,
                email: document.getElementById('regEmail').value,
                password_hash: document.getElementById('regPassword').value,
                firstName: document.getElementById('regFirstName').value,
                lastName: document.getElementById('regLastName').value,
                role: document.getElementById('regRole').value
            };
            await makeRequest('/auth/register', 'POST', data);
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                email: document.getElementById('loginEmail').value,
                password_hash: document.getElementById('loginPassword').value
            };
            const result = await makeRequest('/auth/login', 'POST', data);
            if (result && result.token) {
                authToken = result.token;
                currentUser = result.user;
                updateAuthStatus();
            }
        });

        // Project functions
        document.getElementById('createProjectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('projectName').value,
                description: document.getElementById('projectDescription').value,
                leaderId: document.getElementById('projectLeader').value || null
            };
            await makeRequest('/project/create', 'POST', data);
        });

        document.getElementById('loadProjects').addEventListener('click', async () => {
            const result = await makeRequest('/project/showprojects');
            if (result && result.data) {
                const projectsList = document.getElementById('projectsList');
                projectsList.innerHTML = result.data.map(project => 
                    `<div class="bg-gray-50 p-2 rounded border">
                        <strong>${project.name}</strong> (ID: ${project._id})
                        <br><small class="text-gray-600">${project.description}</small>
                    </div>`
                ).join('');
            }
        });

        // Issue functions
        document.getElementById('createIssueForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                title: document.getElementById('issueTitle').value,
                description: document.getElementById('issueDescription').value,
                type: document.getElementById('issueType').value,
                priority: document.getElementById('issuePriority').value,
                project: document.getElementById('issueProject').value,
                assignedTo: document.getElementById('issueAssignedTo').value || null,
                dueDate: document.getElementById('issueDueDate').value
            };
            await makeRequest('/issue/create', 'POST', data);
        });

        document.getElementById('loadIssues').addEventListener('click', async () => {
            const result = await makeRequest('/issue/showissues');
            if (result && result.issues) {
                const issuesList = document.getElementById('issuesList');
                issuesList.innerHTML = result.issues.map(issue => 
                    `<div class="bg-gray-50 p-2 rounded border">
                        <strong>${issue.title}</strong> (${issue.code})
                        <br><small class="text-gray-600">${issue.type} - ${issue.priority}</small>
                    </div>`
                ).join('');
            }
        });

        // User functions
        document.getElementById('loadUsers').addEventListener('click', async () => {
            const result = await makeRequest('/auth/profiles');
            if (result && result.users) {
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = result.users.map(user => 
                    `<div class="bg-gray-50 p-3 rounded border">
                        <strong>${user.username}</strong>
                        <br><small class="text-gray-600">${user.email}</small>
                        <br><small class="text-blue-600">ID: ${user._id}</small>
                        <br><small class="text-purple-600">Role: ${user.role?.name || 'N/A'}</small>
                    </div>`
                ).join('');
            }
        });

        // Initialize
        updateAuthStatus();
    </script>
</body>
</html>